#!/bin/bash

# phoenix_hypervisor_config.sh
# Configuration variables for the Hypervisor Prep Scripts project.
# Version: 1.1.0 (Incorporates feedback)
# Author: Assistant

# --- Function to load configuration variables ---
load_hypervisor_config() {
    # --- General Hypervisor Settings ---
    # Log file for the hypervisor prep scripts
    HYPERVISOR_LOGFILE="${HYPERVISOR_LOGFILE:-/var/log/hypervisor_prep.log}"
    export HYPERVISOR_LOGFILE

    # Marker file directory
    HYPERVISOR_MARKER_DIR="${HYPERVISOR_MARKER_DIR:-/var/log/hypervisor_prep_markers}"
    export HYPERVISOR_MARKER_DIR

    # --- LXC Container Definitions ---
    # Associative array to hold LXC configurations
    # Key: LXC ID (must be unique)
    # Value: A string containing comma-separated parameters:
    #   name,memory_mb,balloon_min_mb,cores,template,storage_pool,storage_size_gb,nvidia_pci_ids,network_config
    # network_config format: "ip_address/gateway/dns_server" (e.g., "10.0.0.100/24,10.0.0.1,8.8.8.8")
    #   If network_config is empty or "dhcp", DHCP is used.
    # Example for DrToolbox:
    #   ID 901, Name DrToolbox, 32GB RAM, 1GB balloon min, 6 cores, Debian 12, 64GB on lxc-disks, 2x5060Ti, Static IP
    declare -gA LXC_CONFIGS
    LXC_CONFIGS[901]="DrToolbox,32768,1024,6,debian-12-standard_12.0-1_amd64.tar.zst,lxc-disks,64,0000:01:00.0 0000:02:00.0,10.0.0.100/24,10.0.0.1,8.8.8.8"
    # Add more LXC definitions here:
    # LXC_CONFIGS[902]="AnotherContainer,16384,512,4,debian-12-standard_12.0-1_amd64.tar.zst,fastData,32,,dhcp,,"
    # LXC_CONFIGS[903]="YetAnotherContainer,8192,256,2,ubuntu-22.04-standard_22.04-1_amd64.tar.zst,quickOS,128,0000:03:00.0,10.0.0.101/24,10.0.0.1,8.8.8.8"

    export LXC_CONFIGS

    # --- LXC Setup Scripts ---
    # Associative array mapping LXC ID to its specific setup script
    declare -gA LXC_SETUP_SCRIPTS
    LXC_SETUP_SCRIPTS[901]="/usr/local/bin/phoenix_lxc_setup_drtoolbox.sh"
    # Add mappings for other LXCs:
    # LXC_SETUP_SCRIPTS[902]="/usr/local/bin/phoenix_lxc_setup_anothercontainer.sh"

    export LXC_SETUP_SCRIPTS

    # --- LXC Internal Settings (used by setup scripts) ---
    # DrToolbox specific settings (could be moved to its setup script or kept here)
    DRTOOLBOX_NVIDIA_DRIVER_VERSION="575.57.08"  # Should match the host driver version from phoenix_install_nvidia_driver.sh
    DRTOOLBOX_NVIDIA_DRIVER_PKG="nvidia-driver-${DRTOOLBOX_NVIDIA_DRIVER_VERSION}"

    export DRTOOLBOX_NVIDIA_DRIVER_VERSION DRTOOLBOX_NVIDIA_DRIVER_PKG

    # --- Common LXC Setup Options ---
    # Default password for LXC root user (consider more secure methods in production)
    LXC_DEFAULT_ROOT_PASSWORD="${LXC_DEFAULT_ROOT_PASSWORD:-ChangeMe!2024}"

    # Default SSH public key to add to LXC root user (optional)
    LXC_DEFAULT_ROOT_SSH_KEY="${LXC_DEFAULT_ROOT_SSH_KEY:-}"

    export LXC_DEFAULT_ROOT_PASSWORD LXC_DEFAULT_ROOT_SSH_KEY

    log "INFO" "Hypervisor configuration variables loaded and validated"
}

# Ensure this script is sourced, not executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Error: This script is intended to be sourced, not executed directly."
    exit 1
fi
